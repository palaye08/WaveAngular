pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_HUB_REPO = 'palaye769/goldenfly-frontend'
        DOCKER_HUB_CREDENTIALS = 'docker-hub-new'
        RENDER_DEPLOY_HOOK = credentials('render-webhook')
        IMAGE_TAG = 'latest'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'üì¶ R√©cup√©ration du code source depuis GitHub...'
                git branch: 'main',
                    url: 'https://github.com/palaye08/WaveAngular.git'
                    
                sh 'cd Soutenance/goldenfly'
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'üì• Installation des d√©pendances Node.js...'
                dir('Soutenance/goldenfly') {
                    sh '''
                        node --version
                        npm --version
                        npm config set fetch-timeout 600000
                        npm config set fetch-retry-maxtimeout 600000
                        npm install --legacy-peer-deps
                    '''
                }
            }
        }

        stage('Build Angular App') {
            steps {
                echo 'üî® Construction de l\'application Angular...'
                dir('Soutenance/goldenfly') {
                    sh '''
                        npm run build -- --configuration=production
                    '''
                }
            }
        }

        stage('Tests') {
            steps {
                echo 'üß™ Ex√©cution des tests...'
                dir('Soutenance/goldenfly') {
                    sh '''
                        npm run test -- --watch=false --browsers=ChromeHeadless || true
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Construction de l\'image Docker...'
                dir('Soutenance/goldenfly') {
                    script {
                        def imageName = "${DOCKER_HUB_REPO}:${BUILD_NUMBER}"
                        def latestImageName = "${DOCKER_HUB_REPO}:${IMAGE_TAG}"
                        
                        sh """
                            docker build -t ${imageName} .
                            docker tag ${imageName} ${latestImageName}
                        """
                    }
                }
            }
        }

        stage('Push to Docker Registry') {
            steps {
                echo 'üì§ Push de l\'image vers Docker Hub...'
                script {
                    docker.withRegistry('https://registry.hub.docker.com', DOCKER_HUB_CREDENTIALS) {
                        sh """
                            docker push ${DOCKER_HUB_REPO}:${BUILD_NUMBER}
                            docker push ${DOCKER_HUB_REPO}:${IMAGE_TAG}
                        """
                    }
                    
                    // Nettoyage
                    sh """
                        docker rmi ${DOCKER_HUB_REPO}:${BUILD_NUMBER} || true
                        docker rmi ${DOCKER_HUB_REPO}:${IMAGE_TAG} || true
                    """
                }
            }
        }

        stage('Deploy to Render') {
            steps {
                echo 'üöÄ D√©ploiement du frontend sur Render...'
                script {
                    sh '''
                        curl -X POST "$RENDER_DEPLOY_HOOK" \
                            -H "Content-Type: application/json" \
                            -d '{"branch": "main"}'
                    '''
                    echo '‚úÖ Webhook de d√©ploiement envoy√© √† Render'
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo 'üîç V√©rification du d√©ploiement...'
                sh '''
                    echo "‚è≥ Attente du d√©ploiement (60 secondes)..."
                    sleep 60
                    echo "‚úÖ Frontend d√©ploy√© avec succ√®s"
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ Pipeline frontend ex√©cut√© avec succ√®s!'
            echo 'üìä Image Docker: ${DOCKER_HUB_REPO}:${BUILD_NUMBER}'
        }
        failure {
            echo '‚ùå Le pipeline frontend a √©chou√©. V√©rifiez les logs.'
        }
        always {
            echo 'üßπ Nettoyage de l\'espace de travail...'
            cleanWs()
        }
    }
}
